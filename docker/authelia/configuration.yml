server:
  address: "tcp://0.0.0.0:9091"
  buffers:
    read: 4096
    write: 4096

log:
  level: debug

storage:
  encryption_key: '{{ env "AUTHELIA_STORAGE_ENCRYPTION_KEY" }}'
  local:
    path: /config/db.sqlite3

identity_validation:
  reset_password:
    jwt_secret: '{{ env "AUTHELIA_JWT_SECRET" }}'

authentication_backend:
  file:
    path: /config/users_database.yml

access_control:
  default_policy: one_factor
  rules:
    - domain: "*"
      policy: bypass
      resources:
        - "^/api/.*/.*$"
        - "^/.well-known/.*$"
        - "^/userinfo"
        - "^/jwks.json"

session:
  name: authelia_session
  secret: '{{ env "AUTHELIA_SESSION_SECRET" }}'
  expiration: 1h
  inactivity: 5m

  # FIX: Use 'localhost' to allow HTTP URLs without crashing
  cookies:
    - domain: "localhost"
      authelia_url: "http://localhost:9091"
      default_redirection_url: "http://localhost:3000"

  redis:
    host: redis
    port: 6379

regulation:
  max_retries: 3
  find_time: 2m
  ban_time: 5m

notifier:
  filesystem:
    filename: /config/notification.txt

identity_providers:
  oidc:
    hmac_secret: this_is_a_secret_hmac_key
    # FIX: 'key_file' is gone. We use 'key' and the secret template helper.
    jwks:
      - key: '{{ secret "/config/oidc.pem" }}'

    clients:
      - client_id: nextjs-app
        client_name: NextJS App
        client_secret: '{{ env "AUTHELIA_CLIENT_SECRET_HASH" }}'
        public: false
        authorization_policy: one_factor
        redirect_uris:
          - http://localhost:3000/api/auth/callback/authelia
        scopes:
          - openid
          - profile
          - email
